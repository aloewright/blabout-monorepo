"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.updateFlagValue=exports.parsePayload=exports.normalizeDecideResponse=exports.getPayloadsFromFlags=exports.getFlagValuesFromFlags=exports.getFlagDetailsFromFlagsAndPayloads=exports.getFeatureFlagValue=exports.createDecideResponseFromFlagsAndPayloads=void 0;var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable;})),t.push.apply(t,o);}return t;}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach(function(r){(0,_defineProperty2["default"])(e,r,t[r]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r));});}return e;}var normalizeDecideResponse=exports.normalizeDecideResponse=function normalizeDecideResponse(decideResponse){var _a;if('flags'in decideResponse){var featureFlags=getFlagValuesFromFlags(decideResponse.flags);var featureFlagPayloads=getPayloadsFromFlags(decideResponse.flags);return _objectSpread(_objectSpread({},decideResponse),{},{featureFlags:featureFlags,featureFlagPayloads:featureFlagPayloads});}else{var _featureFlags=(_a=decideResponse.featureFlags)!==null&&_a!==void 0?_a:{};var _featureFlagPayloads=Object.fromEntries(Object.entries(decideResponse.featureFlagPayloads||{}).map(function(_ref){var _ref2=(0,_slicedToArray2["default"])(_ref,2),k=_ref2[0],v=_ref2[1];return[k,parsePayload(v)];}));var flags=Object.fromEntries(Object.entries(_featureFlags).map(function(_ref3){var _ref4=(0,_slicedToArray2["default"])(_ref3,2),key=_ref4[0],value=_ref4[1];return[key,getFlagDetailFromFlagAndPayload(key,value,_featureFlagPayloads[key])];}));return _objectSpread(_objectSpread({},decideResponse),{},{featureFlags:_featureFlags,featureFlagPayloads:_featureFlagPayloads,flags:flags});}};function getFlagDetailFromFlagAndPayload(key,value,payload){return{key:key,enabled:typeof value==='string'?true:value,variant:typeof value==='string'?value:undefined,reason:undefined,metadata:{id:undefined,version:undefined,payload:payload?JSON.stringify(payload):undefined,description:undefined}};}var getFlagValuesFromFlags=exports.getFlagValuesFromFlags=function getFlagValuesFromFlags(flags){return Object.fromEntries(Object.entries(flags!==null&&flags!==void 0?flags:{}).map(function(_ref5){var _ref6=(0,_slicedToArray2["default"])(_ref5,2),key=_ref6[0],detail=_ref6[1];return[key,getFeatureFlagValue(detail)];}).filter(function(_ref7){var _ref8=(0,_slicedToArray2["default"])(_ref7,2),value=_ref8[1];return value!==undefined;}));};var getPayloadsFromFlags=exports.getPayloadsFromFlags=function getPayloadsFromFlags(flags){var safeFlags=flags!==null&&flags!==void 0?flags:{};return Object.fromEntries(Object.keys(safeFlags).filter(function(flag){var details=safeFlags[flag];return details.enabled&&details.metadata&&details.metadata.payload!==undefined;}).map(function(flag){var _a;var payload=(_a=safeFlags[flag].metadata)===null||_a===void 0?void 0:_a.payload;return[flag,payload?parsePayload(payload):undefined];}));};var getFlagDetailsFromFlagsAndPayloads=exports.getFlagDetailsFromFlagsAndPayloads=function getFlagDetailsFromFlagsAndPayloads(decideResponse){var _a,_b;var flags=(_a=decideResponse.featureFlags)!==null&&_a!==void 0?_a:{};var payloads=(_b=decideResponse.featureFlagPayloads)!==null&&_b!==void 0?_b:{};return Object.fromEntries(Object.entries(flags).map(function(_ref9){var _ref10=(0,_slicedToArray2["default"])(_ref9,2),key=_ref10[0],value=_ref10[1];return[key,{key:key,enabled:typeof value==='string'?true:value,variant:typeof value==='string'?value:undefined,reason:undefined,metadata:{id:undefined,version:undefined,payload:(payloads===null||payloads===void 0?void 0:payloads[key])?JSON.stringify(payloads[key]):undefined,description:undefined}}];}));};var getFeatureFlagValue=exports.getFeatureFlagValue=function getFeatureFlagValue(detail){var _a;return detail===undefined?undefined:(_a=detail.variant)!==null&&_a!==void 0?_a:detail.enabled;};var parsePayload=exports.parsePayload=function parsePayload(response){if(typeof response!=='string'){return response;}try{return JSON.parse(response);}catch(_a){return response;}};var createDecideResponseFromFlagsAndPayloads=exports.createDecideResponseFromFlagsAndPayloads=function createDecideResponseFromFlagsAndPayloads(featureFlags,featureFlagPayloads){var allKeys=(0,_toConsumableArray2["default"])(new Set([].concat((0,_toConsumableArray2["default"])(Object.keys(featureFlags!==null&&featureFlags!==void 0?featureFlags:{})),(0,_toConsumableArray2["default"])(Object.keys(featureFlagPayloads!==null&&featureFlagPayloads!==void 0?featureFlagPayloads:{})))));var enabledFlags=allKeys.filter(function(flag){return!!featureFlags[flag]||!!featureFlagPayloads[flag];}).reduce(function(res,key){var _a;return res[key]=(_a=featureFlags[key])!==null&&_a!==void 0?_a:true,res;},{});var flagDetails={featureFlags:enabledFlags,featureFlagPayloads:featureFlagPayloads!==null&&featureFlagPayloads!==void 0?featureFlagPayloads:{}};return normalizeDecideResponse(flagDetails);};var updateFlagValue=exports.updateFlagValue=function updateFlagValue(flag,value){return _objectSpread(_objectSpread({},flag),{},{enabled:getEnabledFromValue(value),variant:getVariantFromValue(value)});};function getEnabledFromValue(value){return typeof value==='string'?true:value;}function getVariantFromValue(value){return typeof value==='string'?value:undefined;}