"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _typeof3=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:true});var _exportNames={maybeAdd:true,logFlushError:true,PostHogCoreStateless:true,PostHogCore:true,getFeatureFlagValue:true,safeSetTimeout:true,getFetch:true,utils:true,LZString:true};Object.defineProperty(exports,"LZString",{enumerable:true,get:function get(){return _lzString.LZString;}});exports.PostHogCoreStateless=exports.PostHogCore=void 0;Object.defineProperty(exports,"getFeatureFlagValue",{enumerable:true,get:function get(){return _featureFlagUtils.getFeatureFlagValue;}});Object.defineProperty(exports,"getFetch",{enumerable:true,get:function get(){return _utils2.getFetch;}});exports.logFlushError=logFlushError;exports.maybeAdd=void 0;Object.defineProperty(exports,"safeSetTimeout",{enumerable:true,get:function get(){return _utils2.safeSetTimeout;}});exports.utils=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _get2=_interopRequireDefault(require("@babel/runtime/helpers/get"));var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var _wrapNativeSuper2=_interopRequireDefault(require("@babel/runtime/helpers/wrapNativeSuper"));var _types=require("./types");Object.keys(_types).forEach(function(key){if(key==="default"||key==="__esModule")return;if(Object.prototype.hasOwnProperty.call(_exportNames,key))return;if(key in exports&&exports[key]===_types[key])return;Object.defineProperty(exports,key,{enumerable:true,get:function get(){return _types[key];}});});var _featureFlagUtils=require("./featureFlagUtils");var _utils2=_interopRequireWildcard(require("./utils"));var _utils=_utils2;exports.utils=_utils2;var _lzString=require("./lz-string");var _eventemitter=require("./eventemitter");var _uuidv=require("./vendor/uuidv7");function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap(),t=new WeakMap();return(_getRequireWildcardCache=function _getRequireWildcardCache(e){return e?t:r;})(e);}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=_typeof3(e)&&"function"!=typeof e)return{"default":e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in e)if("default"!==u&&{}.hasOwnProperty.call(e,u)){var i=a?Object.getOwnPropertyDescriptor(e,u):null;i&&(i.get||i.set)?Object.defineProperty(n,u,i):n[u]=e[u];}return n["default"]=e,t&&t.set(e,n),n;}function _superPropGet(t,e,o,r){var p=(0,_get2["default"])((0,_getPrototypeOf2["default"])(1&r?t.prototype:t),e,o);return 2&r&&"function"==typeof p?function(t){return p.apply(o,t);}:p;}function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable;})),t.push.apply(t,o);}return t;}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach(function(r){(0,_defineProperty2["default"])(e,r,t[r]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r));});}return e;}function _callSuper(t,o,e){return o=(0,_getPrototypeOf2["default"])(o),(0,_possibleConstructorReturn2["default"])(t,_isNativeReflectConstruct()?Reflect.construct(o,e||[],(0,_getPrototypeOf2["default"])(t).constructor):o.apply(t,e));}function _isNativeReflectConstruct(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));}catch(t){}return(_isNativeReflectConstruct=function _isNativeReflectConstruct(){return!!t;})();}var PostHogFetchHttpError=function(_Error){function PostHogFetchHttpError(response,reqByteLength){var _this;(0,_classCallCheck2["default"])(this,PostHogFetchHttpError);_this=_callSuper(this,PostHogFetchHttpError,['HTTP error while fetching PostHog: status='+response.status+', reqByteLength='+reqByteLength]);_this.response=response;_this.reqByteLength=reqByteLength;_this.name='PostHogFetchHttpError';return _this;}(0,_inherits2["default"])(PostHogFetchHttpError,_Error);return(0,_createClass2["default"])(PostHogFetchHttpError,[{key:"status",get:function get(){return this.response.status;}},{key:"text",get:function get(){return this.response.text();}},{key:"json",get:function get(){return this.response.json();}}]);}((0,_wrapNativeSuper2["default"])(Error));var PostHogFetchNetworkError=function(_Error2){function PostHogFetchNetworkError(error){var _this2;(0,_classCallCheck2["default"])(this,PostHogFetchNetworkError);_this2=_callSuper(this,PostHogFetchNetworkError,['Network error while fetching PostHog',error instanceof Error?{cause:error}:{}]);_this2.error=error;_this2.name='PostHogFetchNetworkError';return _this2;}(0,_inherits2["default"])(PostHogFetchNetworkError,_Error2);return(0,_createClass2["default"])(PostHogFetchNetworkError);}((0,_wrapNativeSuper2["default"])(Error));var maybeAdd=exports.maybeAdd=function maybeAdd(key,value){return value!==undefined?(0,_defineProperty2["default"])({},key,value):{};};function logFlushError(_x){return _logFlushError.apply(this,arguments);}function _logFlushError(){_logFlushError=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee37(err){var text;return _regenerator["default"].wrap(function _callee37$(_context38){while(1)switch(_context38.prev=_context38.next){case 0:if(!(err instanceof PostHogFetchHttpError)){_context38.next=13;break;}text='';_context38.prev=2;_context38.next=5;return err.text;case 5:text=_context38.sent;_context38.next=10;break;case 8:_context38.prev=8;_context38.t0=_context38["catch"](2);case 10:console.error("Error while flushing PostHog: message=".concat(err.message,", response body=").concat(text),err);_context38.next=14;break;case 13:console.error('Error while flushing PostHog',err);case 14:return _context38.abrupt("return",Promise.resolve());case 15:case"end":return _context38.stop();}},_callee37,null,[[2,8]]);}));return _logFlushError.apply(this,arguments);}function isPostHogFetchError(err){return(0,_typeof2["default"])(err)==='object'&&(err instanceof PostHogFetchHttpError||err instanceof PostHogFetchNetworkError);}function isPostHogFetchContentTooLargeError(err){return(0,_typeof2["default"])(err)==='object'&&err instanceof PostHogFetchHttpError&&err.status===413;}var QuotaLimitedFeature;(function(QuotaLimitedFeature){QuotaLimitedFeature["FeatureFlags"]="feature_flags";QuotaLimitedFeature["Recordings"]="recordings";})(QuotaLimitedFeature||(QuotaLimitedFeature={}));var PostHogCoreStateless=exports.PostHogCoreStateless=function(){function PostHogCoreStateless(apiKey,options){(0,_classCallCheck2["default"])(this,PostHogCoreStateless);var _a,_b,_c,_d,_e,_f,_g,_h,_j,_k,_l,_m,_o,_p;this.flushPromise=null;this.shutdownPromise=null;this.pendingPromises={};this._events=new _eventemitter.SimpleEventEmitter();this._isInitialized=false;(0,_utils2.assert)(apiKey,"You must pass your PostHog project's api key.");this.apiKey=apiKey;this.host=(0,_utils2.removeTrailingSlash)((options===null||options===void 0?void 0:options.host)||'https://us.i.posthog.com');this.flushAt=(options===null||options===void 0?void 0:options.flushAt)?Math.max(options===null||options===void 0?void 0:options.flushAt,1):20;this.maxBatchSize=Math.max(this.flushAt,(_a=options===null||options===void 0?void 0:options.maxBatchSize)!==null&&_a!==void 0?_a:100);this.maxQueueSize=Math.max(this.flushAt,(_b=options===null||options===void 0?void 0:options.maxQueueSize)!==null&&_b!==void 0?_b:1000);this.flushInterval=(_c=options===null||options===void 0?void 0:options.flushInterval)!==null&&_c!==void 0?_c:10000;this.captureMode=(options===null||options===void 0?void 0:options.captureMode)||'json';this.preloadFeatureFlags=(_d=options===null||options===void 0?void 0:options.preloadFeatureFlags)!==null&&_d!==void 0?_d:true;this.defaultOptIn=(_e=options===null||options===void 0?void 0:options.defaultOptIn)!==null&&_e!==void 0?_e:true;this.disableSurveys=(_f=options===null||options===void 0?void 0:options.disableSurveys)!==null&&_f!==void 0?_f:false;this._retryOptions={retryCount:(_g=options===null||options===void 0?void 0:options.fetchRetryCount)!==null&&_g!==void 0?_g:3,retryDelay:(_h=options===null||options===void 0?void 0:options.fetchRetryDelay)!==null&&_h!==void 0?_h:3000,retryCheck:isPostHogFetchError};this.requestTimeout=(_j=options===null||options===void 0?void 0:options.requestTimeout)!==null&&_j!==void 0?_j:10000;this.featureFlagsRequestTimeoutMs=(_k=options===null||options===void 0?void 0:options.featureFlagsRequestTimeoutMs)!==null&&_k!==void 0?_k:3000;this.remoteConfigRequestTimeoutMs=(_l=options===null||options===void 0?void 0:options.remoteConfigRequestTimeoutMs)!==null&&_l!==void 0?_l:3000;this.disableGeoip=(_m=options===null||options===void 0?void 0:options.disableGeoip)!==null&&_m!==void 0?_m:true;this.disabled=(_o=options===null||options===void 0?void 0:options.disabled)!==null&&_o!==void 0?_o:false;this.historicalMigration=(_p=options===null||options===void 0?void 0:options.historicalMigration)!==null&&_p!==void 0?_p:false;this._initPromise=Promise.resolve();this._isInitialized=true;}return(0,_createClass2["default"])(PostHogCoreStateless,[{key:"logMsgIfDebug",value:function logMsgIfDebug(fn){if(this.isDebug){fn();}}},{key:"wrap",value:function wrap(fn){if(this.disabled){this.logMsgIfDebug(function(){return console.warn('[PostHog] The client is disabled');});return;}if(this._isInitialized){return fn();}this._initPromise.then(function(){return fn();});}},{key:"getCommonEventProperties",value:function getCommonEventProperties(){return{$lib:this.getLibraryId(),$lib_version:this.getLibraryVersion()};}},{key:"optedOut",get:function get(){var _a;return(_a=this.getPersistedProperty(_types.PostHogPersistedProperty.OptedOut))!==null&&_a!==void 0?_a:!this.defaultOptIn;}},{key:"optIn",value:function(){var _optIn=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee(){var _this3=this;return _regenerator["default"].wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:this.wrap(function(){_this3.setPersistedProperty(_types.PostHogPersistedProperty.OptedOut,false);});case 1:case"end":return _context.stop();}},_callee,this);}));function optIn(){return _optIn.apply(this,arguments);}return optIn;}()},{key:"optOut",value:function(){var _optOut=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee2(){var _this4=this;return _regenerator["default"].wrap(function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:this.wrap(function(){_this4.setPersistedProperty(_types.PostHogPersistedProperty.OptedOut,true);});case 1:case"end":return _context2.stop();}},_callee2,this);}));function optOut(){return _optOut.apply(this,arguments);}return optOut;}()},{key:"on",value:function on(event,cb){return this._events.on(event,cb);}},{key:"debug",value:function debug(){var _this5=this;var enabled=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;var _a;(_a=this.removeDebugCallback)===null||_a===void 0?void 0:_a.call(this);if(enabled){var removeDebugCallback=this.on('*',function(event,payload){return console.log('PostHog Debug',event,payload);});this.removeDebugCallback=function(){removeDebugCallback();_this5.removeDebugCallback=undefined;};}}},{key:"isDebug",get:function get(){return!!this.removeDebugCallback;}},{key:"isDisabled",get:function get(){return this.disabled;}},{key:"buildPayload",value:function buildPayload(payload){return{distinct_id:payload.distinct_id,event:payload.event,properties:_objectSpread(_objectSpread({},payload.properties||{}),this.getCommonEventProperties())};}},{key:"addPendingPromise",value:function addPendingPromise(promise){var _this6=this;var promiseUUID=(0,_uuidv.uuidv7)();this.pendingPromises[promiseUUID]=promise;promise["catch"](function(){})["finally"](function(){delete _this6.pendingPromises[promiseUUID];});return promise;}},{key:"identifyStateless",value:function identifyStateless(distinctId,properties,options){var _this7=this;this.wrap(function(){var payload=_objectSpread({},_this7.buildPayload({distinct_id:distinctId,event:'$identify',properties:properties}));_this7.enqueue('identify',payload,options);});}},{key:"identifyStatelessImmediate",value:function(){var _identifyStatelessImmediate=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee3(distinctId,properties,options){var payload;return _regenerator["default"].wrap(function _callee3$(_context3){while(1)switch(_context3.prev=_context3.next){case 0:payload=_objectSpread({},this.buildPayload({distinct_id:distinctId,event:'$identify',properties:properties}));_context3.next=3;return this.sendImmediate('identify',payload,options);case 3:case"end":return _context3.stop();}},_callee3,this);}));function identifyStatelessImmediate(_x2,_x3,_x4){return _identifyStatelessImmediate.apply(this,arguments);}return identifyStatelessImmediate;}()},{key:"captureStateless",value:function captureStateless(distinctId,event,properties,options){var _this8=this;this.wrap(function(){var payload=_this8.buildPayload({distinct_id:distinctId,event:event,properties:properties});_this8.enqueue('capture',payload,options);});}},{key:"captureStatelessImmediate",value:function(){var _captureStatelessImmediate=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee4(distinctId,event,properties,options){var payload;return _regenerator["default"].wrap(function _callee4$(_context4){while(1)switch(_context4.prev=_context4.next){case 0:payload=this.buildPayload({distinct_id:distinctId,event:event,properties:properties});_context4.next=3;return this.sendImmediate('capture',payload,options);case 3:case"end":return _context4.stop();}},_callee4,this);}));function captureStatelessImmediate(_x5,_x6,_x7,_x8){return _captureStatelessImmediate.apply(this,arguments);}return captureStatelessImmediate;}()},{key:"aliasStateless",value:function aliasStateless(alias,distinctId,properties,options){var _this9=this;this.wrap(function(){var payload=_this9.buildPayload({event:'$create_alias',distinct_id:distinctId,properties:_objectSpread(_objectSpread({},properties||{}),{},{distinct_id:distinctId,alias:alias})});_this9.enqueue('alias',payload,options);});}},{key:"aliasStatelessImmediate",value:function(){var _aliasStatelessImmediate=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee5(alias,distinctId,properties,options){var payload;return _regenerator["default"].wrap(function _callee5$(_context5){while(1)switch(_context5.prev=_context5.next){case 0:payload=this.buildPayload({event:'$create_alias',distinct_id:distinctId,properties:_objectSpread(_objectSpread({},properties||{}),{},{distinct_id:distinctId,alias:alias})});_context5.next=3;return this.sendImmediate('alias',payload,options);case 3:case"end":return _context5.stop();}},_callee5,this);}));function aliasStatelessImmediate(_x9,_x10,_x11,_x12){return _aliasStatelessImmediate.apply(this,arguments);}return aliasStatelessImmediate;}()},{key:"groupIdentifyStateless",value:function groupIdentifyStateless(groupType,groupKey,groupProperties,options,distinctId,eventProperties){var _this10=this;this.wrap(function(){var payload=_this10.buildPayload({distinct_id:distinctId||"$".concat(groupType,"_").concat(groupKey),event:'$groupidentify',properties:_objectSpread({$group_type:groupType,$group_key:groupKey,$group_set:groupProperties||{}},eventProperties||{})});_this10.enqueue('capture',payload,options);});}},{key:"getRemoteConfig",value:function(){var _getRemoteConfig=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee6(){var _this11=this;var host,url,fetchOptions;return _regenerator["default"].wrap(function _callee6$(_context6){while(1)switch(_context6.prev=_context6.next){case 0:_context6.next=2;return this._initPromise;case 2:host=this.host;if(host==='https://us.i.posthog.com'){host='https://us-assets.i.posthog.com';}else if(host==='https://eu.i.posthog.com'){host='https://eu-assets.i.posthog.com';}url="".concat(host,"/array/").concat(this.apiKey,"/config");fetchOptions={method:'GET',headers:_objectSpread(_objectSpread({},this.getCustomHeaders()),{},{'Content-Type':'application/json'})};return _context6.abrupt("return",this.fetchWithRetry(url,fetchOptions,{retryCount:0},this.remoteConfigRequestTimeoutMs).then(function(response){return response.json();})["catch"](function(error){_this11.logMsgIfDebug(function(){return console.error('Remote config could not be loaded',error);});_this11._events.emit('error',error);return undefined;}));case 7:case"end":return _context6.stop();}},_callee6,this);}));function getRemoteConfig(){return _getRemoteConfig.apply(this,arguments);}return getRemoteConfig;}()},{key:"getDecide",value:(function(){var _getDecide=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee7(distinctId){var _this12=this;var groups,personProperties,groupProperties,extraPayload,useFlags,url,fetchOptions,_args7=arguments;return _regenerator["default"].wrap(function _callee7$(_context7){while(1)switch(_context7.prev=_context7.next){case 0:groups=_args7.length>1&&_args7[1]!==undefined?_args7[1]:{};personProperties=_args7.length>2&&_args7[2]!==undefined?_args7[2]:{};groupProperties=_args7.length>3&&_args7[3]!==undefined?_args7[3]:{};extraPayload=_args7.length>4&&_args7[4]!==undefined?_args7[4]:{};_context7.next=6;return this._initPromise;case 6:useFlags=(0,_utils2.isTokenInRollout)(this.apiKey,_utils2.NEW_FLAGS_ROLLOUT_PERCENTAGE,_utils2.NEW_FLAGS_EXCLUDED_HASHES);url=useFlags?"".concat(this.host,"/flags/?v=2"):"".concat(this.host,"/decide/?v=4");fetchOptions={method:'POST',headers:_objectSpread(_objectSpread({},this.getCustomHeaders()),{},{'Content-Type':'application/json'}),body:JSON.stringify(_objectSpread({token:this.apiKey,distinct_id:distinctId,groups:groups,person_properties:personProperties,group_properties:groupProperties},extraPayload))};this.logMsgIfDebug(function(){return console.log('PostHog Debug','Decide URL',url);});return _context7.abrupt("return",this.fetchWithRetry(url,fetchOptions,{retryCount:0},this.featureFlagsRequestTimeoutMs).then(function(response){return response.json();}).then(function(response){return(0,_featureFlagUtils.normalizeDecideResponse)(response);})["catch"](function(error){_this12._events.emit('error',error);return undefined;}));case 11:case"end":return _context7.stop();}},_callee7,this);}));function getDecide(_x13){return _getDecide.apply(this,arguments);}return getDecide;}())},{key:"getFeatureFlagStateless",value:function(){var _getFeatureFlagStateless=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee8(key,distinctId){var groups,personProperties,groupProperties,disableGeoip,flagDetailResponse,response,_args8=arguments;return _regenerator["default"].wrap(function _callee8$(_context8){while(1)switch(_context8.prev=_context8.next){case 0:groups=_args8.length>2&&_args8[2]!==undefined?_args8[2]:{};personProperties=_args8.length>3&&_args8[3]!==undefined?_args8[3]:{};groupProperties=_args8.length>4&&_args8[4]!==undefined?_args8[4]:{};disableGeoip=_args8.length>5?_args8[5]:undefined;_context8.next=6;return this._initPromise;case 6:_context8.next=8;return this.getFeatureFlagDetailStateless(key,distinctId,groups,personProperties,groupProperties,disableGeoip);case 8:flagDetailResponse=_context8.sent;if(!(flagDetailResponse===undefined)){_context8.next=11;break;}return _context8.abrupt("return",{response:undefined,requestId:undefined});case 11:response=(0,_featureFlagUtils.getFeatureFlagValue)(flagDetailResponse.response);if(response===undefined){response=false;}return _context8.abrupt("return",{response:response,requestId:flagDetailResponse.requestId});case 14:case"end":return _context8.stop();}},_callee8,this);}));function getFeatureFlagStateless(_x14,_x15){return _getFeatureFlagStateless.apply(this,arguments);}return getFeatureFlagStateless;}()},{key:"getFeatureFlagDetailStateless",value:function(){var _getFeatureFlagDetailStateless=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee9(key,distinctId){var groups,personProperties,groupProperties,disableGeoip,decideResponse,featureFlags,flagDetail,_args9=arguments;return _regenerator["default"].wrap(function _callee9$(_context9){while(1)switch(_context9.prev=_context9.next){case 0:groups=_args9.length>2&&_args9[2]!==undefined?_args9[2]:{};personProperties=_args9.length>3&&_args9[3]!==undefined?_args9[3]:{};groupProperties=_args9.length>4&&_args9[4]!==undefined?_args9[4]:{};disableGeoip=_args9.length>5?_args9[5]:undefined;_context9.next=6;return this._initPromise;case 6:_context9.next=8;return this.getFeatureFlagDetailsStateless(distinctId,groups,personProperties,groupProperties,disableGeoip,[key]);case 8:decideResponse=_context9.sent;if(!(decideResponse===undefined)){_context9.next=11;break;}return _context9.abrupt("return",undefined);case 11:featureFlags=decideResponse.flags;flagDetail=featureFlags[key];return _context9.abrupt("return",{response:flagDetail,requestId:decideResponse.requestId});case 14:case"end":return _context9.stop();}},_callee9,this);}));function getFeatureFlagDetailStateless(_x16,_x17){return _getFeatureFlagDetailStateless.apply(this,arguments);}return getFeatureFlagDetailStateless;}()},{key:"getFeatureFlagPayloadStateless",value:function(){var _getFeatureFlagPayloadStateless=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee10(key,distinctId){var groups,personProperties,groupProperties,disableGeoip,payloads,response,_args10=arguments;return _regenerator["default"].wrap(function _callee10$(_context10){while(1)switch(_context10.prev=_context10.next){case 0:groups=_args10.length>2&&_args10[2]!==undefined?_args10[2]:{};personProperties=_args10.length>3&&_args10[3]!==undefined?_args10[3]:{};groupProperties=_args10.length>4&&_args10[4]!==undefined?_args10[4]:{};disableGeoip=_args10.length>5?_args10[5]:undefined;_context10.next=6;return this._initPromise;case 6:_context10.next=8;return this.getFeatureFlagPayloadsStateless(distinctId,groups,personProperties,groupProperties,disableGeoip,[key]);case 8:payloads=_context10.sent;if(payloads){_context10.next=11;break;}return _context10.abrupt("return",undefined);case 11:response=payloads[key];if(!(response===undefined)){_context10.next=14;break;}return _context10.abrupt("return",null);case 14:return _context10.abrupt("return",response);case 15:case"end":return _context10.stop();}},_callee10,this);}));function getFeatureFlagPayloadStateless(_x18,_x19){return _getFeatureFlagPayloadStateless.apply(this,arguments);}return getFeatureFlagPayloadStateless;}()},{key:"getFeatureFlagPayloadsStateless",value:function(){var _getFeatureFlagPayloadsStateless=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee11(distinctId){var groups,personProperties,groupProperties,disableGeoip,flagKeysToEvaluate,payloads,_args11=arguments;return _regenerator["default"].wrap(function _callee11$(_context11){while(1)switch(_context11.prev=_context11.next){case 0:groups=_args11.length>1&&_args11[1]!==undefined?_args11[1]:{};personProperties=_args11.length>2&&_args11[2]!==undefined?_args11[2]:{};groupProperties=_args11.length>3&&_args11[3]!==undefined?_args11[3]:{};disableGeoip=_args11.length>4?_args11[4]:undefined;flagKeysToEvaluate=_args11.length>5?_args11[5]:undefined;_context11.next=7;return this._initPromise;case 7:_context11.next=9;return this.getFeatureFlagsAndPayloadsStateless(distinctId,groups,personProperties,groupProperties,disableGeoip,flagKeysToEvaluate);case 9:payloads=_context11.sent.payloads;return _context11.abrupt("return",payloads);case 11:case"end":return _context11.stop();}},_callee11,this);}));function getFeatureFlagPayloadsStateless(_x20){return _getFeatureFlagPayloadsStateless.apply(this,arguments);}return getFeatureFlagPayloadsStateless;}()},{key:"getFeatureFlagsStateless",value:function(){var _getFeatureFlagsStateless=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee12(distinctId){var groups,personProperties,groupProperties,disableGeoip,flagKeysToEvaluate,_args12=arguments;return _regenerator["default"].wrap(function _callee12$(_context12){while(1)switch(_context12.prev=_context12.next){case 0:groups=_args12.length>1&&_args12[1]!==undefined?_args12[1]:{};personProperties=_args12.length>2&&_args12[2]!==undefined?_args12[2]:{};groupProperties=_args12.length>3&&_args12[3]!==undefined?_args12[3]:{};disableGeoip=_args12.length>4?_args12[4]:undefined;flagKeysToEvaluate=_args12.length>5?_args12[5]:undefined;_context12.next=7;return this._initPromise;case 7:_context12.next=9;return this.getFeatureFlagsAndPayloadsStateless(distinctId,groups,personProperties,groupProperties,disableGeoip,flagKeysToEvaluate);case 9:return _context12.abrupt("return",_context12.sent);case 10:case"end":return _context12.stop();}},_callee12,this);}));function getFeatureFlagsStateless(_x21){return _getFeatureFlagsStateless.apply(this,arguments);}return getFeatureFlagsStateless;}()},{key:"getFeatureFlagsAndPayloadsStateless",value:function(){var _getFeatureFlagsAndPayloadsStateless=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee13(distinctId){var groups,personProperties,groupProperties,disableGeoip,flagKeysToEvaluate,featureFlagDetails,_args13=arguments;return _regenerator["default"].wrap(function _callee13$(_context13){while(1)switch(_context13.prev=_context13.next){case 0:groups=_args13.length>1&&_args13[1]!==undefined?_args13[1]:{};personProperties=_args13.length>2&&_args13[2]!==undefined?_args13[2]:{};groupProperties=_args13.length>3&&_args13[3]!==undefined?_args13[3]:{};disableGeoip=_args13.length>4?_args13[4]:undefined;flagKeysToEvaluate=_args13.length>5?_args13[5]:undefined;_context13.next=7;return this._initPromise;case 7:_context13.next=9;return this.getFeatureFlagDetailsStateless(distinctId,groups,personProperties,groupProperties,disableGeoip,flagKeysToEvaluate);case 9:featureFlagDetails=_context13.sent;if(featureFlagDetails){_context13.next=12;break;}return _context13.abrupt("return",{flags:undefined,payloads:undefined,requestId:undefined});case 12:return _context13.abrupt("return",{flags:featureFlagDetails.featureFlags,payloads:featureFlagDetails.featureFlagPayloads,requestId:featureFlagDetails.requestId});case 13:case"end":return _context13.stop();}},_callee13,this);}));function getFeatureFlagsAndPayloadsStateless(_x22){return _getFeatureFlagsAndPayloadsStateless.apply(this,arguments);}return getFeatureFlagsAndPayloadsStateless;}()},{key:"getFeatureFlagDetailsStateless",value:function(){var _getFeatureFlagDetailsStateless=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee14(distinctId){var groups,personProperties,groupProperties,disableGeoip,flagKeysToEvaluate,_a,extraPayload,decideResponse,_args14=arguments;return _regenerator["default"].wrap(function _callee14$(_context14){while(1)switch(_context14.prev=_context14.next){case 0:groups=_args14.length>1&&_args14[1]!==undefined?_args14[1]:{};personProperties=_args14.length>2&&_args14[2]!==undefined?_args14[2]:{};groupProperties=_args14.length>3&&_args14[3]!==undefined?_args14[3]:{};disableGeoip=_args14.length>4?_args14[4]:undefined;flagKeysToEvaluate=_args14.length>5?_args14[5]:undefined;_context14.next=7;return this._initPromise;case 7:extraPayload={};if(disableGeoip!==null&&disableGeoip!==void 0?disableGeoip:this.disableGeoip){extraPayload['geoip_disable']=true;}if(flagKeysToEvaluate){extraPayload['flag_keys_to_evaluate']=flagKeysToEvaluate;}_context14.next=12;return this.getDecide(distinctId,groups,personProperties,groupProperties,extraPayload);case 12:decideResponse=_context14.sent;if(!(decideResponse===undefined)){_context14.next=15;break;}return _context14.abrupt("return",undefined);case 15:if(decideResponse.errorsWhileComputingFlags){console.error('[FEATURE FLAGS] Error while computing feature flags, some flags may be missing or incorrect. Learn more at https://posthog.com/docs/feature-flags/best-practices');}if(!((_a=decideResponse.quotaLimited)===null||_a===void 0?void 0:_a.includes(QuotaLimitedFeature.FeatureFlags))){_context14.next=19;break;}console.warn('[FEATURE FLAGS] Feature flags quota limit exceeded - feature flags unavailable. Learn more about billing limits at https://posthog.com/docs/billing/limits-alerts');return _context14.abrupt("return",{flags:{},featureFlags:{},featureFlagPayloads:{},requestId:decideResponse===null||decideResponse===void 0?void 0:decideResponse.requestId});case 19:return _context14.abrupt("return",decideResponse);case 20:case"end":return _context14.stop();}},_callee14,this);}));function getFeatureFlagDetailsStateless(_x23){return _getFeatureFlagDetailsStateless.apply(this,arguments);}return getFeatureFlagDetailsStateless;}()},{key:"getSurveysStateless",value:(function(){var _getSurveysStateless=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee15(){var _this13=this;var url,fetchOptions,response,newSurveys;return _regenerator["default"].wrap(function _callee15$(_context15){while(1)switch(_context15.prev=_context15.next){case 0:_context15.next=2;return this._initPromise;case 2:if(!(this.disableSurveys===true)){_context15.next=5;break;}this.logMsgIfDebug(function(){return console.log('PostHog Debug','Loading surveys is disabled.');});return _context15.abrupt("return",[]);case 5:url="".concat(this.host,"/api/surveys/?token=").concat(this.apiKey);fetchOptions={method:'GET',headers:_objectSpread(_objectSpread({},this.getCustomHeaders()),{},{'Content-Type':'application/json'})};_context15.next=9;return this.fetchWithRetry(url,fetchOptions).then(function(response){if(response.status!==200||!response.json){var msg="Surveys API could not be loaded: ".concat(response.status);var error=new Error(msg);_this13.logMsgIfDebug(function(){return console.error(error);});_this13._events.emit('error',new Error(msg));return undefined;}return response.json();})["catch"](function(error){_this13.logMsgIfDebug(function(){return console.error('Surveys API could not be loaded',error);});_this13._events.emit('error',error);return undefined;});case 9:response=_context15.sent;newSurveys=response===null||response===void 0?void 0:response.surveys;if(newSurveys){this.logMsgIfDebug(function(){return console.log('PostHog Debug','Surveys fetched from API: ',JSON.stringify(newSurveys));});}return _context15.abrupt("return",newSurveys!==null&&newSurveys!==void 0?newSurveys:[]);case 13:case"end":return _context15.stop();}},_callee15,this);}));function getSurveysStateless(){return _getSurveysStateless.apply(this,arguments);}return getSurveysStateless;}())},{key:"props",get:function get(){if(!this._props){this._props=this.getPersistedProperty(_types.PostHogPersistedProperty.Props);}return this._props||{};},set:function set(val){this._props=val;}},{key:"register",value:function(){var _register=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee16(properties){var _this14=this;return _regenerator["default"].wrap(function _callee16$(_context16){while(1)switch(_context16.prev=_context16.next){case 0:this.wrap(function(){_this14.props=_objectSpread(_objectSpread({},_this14.props),properties);_this14.setPersistedProperty(_types.PostHogPersistedProperty.Props,_this14.props);});case 1:case"end":return _context16.stop();}},_callee16,this);}));function register(_x24){return _register.apply(this,arguments);}return register;}()},{key:"unregister",value:function(){var _unregister=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee17(property){var _this15=this;return _regenerator["default"].wrap(function _callee17$(_context17){while(1)switch(_context17.prev=_context17.next){case 0:this.wrap(function(){delete _this15.props[property];_this15.setPersistedProperty(_types.PostHogPersistedProperty.Props,_this15.props);});case 1:case"end":return _context17.stop();}},_callee17,this);}));function unregister(_x25){return _unregister.apply(this,arguments);}return unregister;}()},{key:"enqueue",value:function enqueue(type,_message,options){var _this16=this;this.wrap(function(){if(_this16.optedOut){_this16._events.emit(type,"Library is disabled. Not sending event. To re-enable, call posthog.optIn()");return;}var message=_this16.prepareMessage(type,_message,options);var queue=_this16.getPersistedProperty(_types.PostHogPersistedProperty.Queue)||[];if(queue.length>=_this16.maxQueueSize){queue.shift();_this16.logMsgIfDebug(function(){return console.info('Queue is full, the oldest event is dropped.');});}queue.push({message:message});_this16.setPersistedProperty(_types.PostHogPersistedProperty.Queue,queue);_this16._events.emit(type,message);if(queue.length>=_this16.flushAt){_this16.flushBackground();}if(_this16.flushInterval&&!_this16._flushTimer){_this16._flushTimer=(0,_utils2.safeSetTimeout)(function(){return _this16.flushBackground();},_this16.flushInterval);}});}},{key:"sendImmediate",value:function(){var _sendImmediate=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee18(type,_message,options){var data,payload,url,fetchOptions;return _regenerator["default"].wrap(function _callee18$(_context18){while(1)switch(_context18.prev=_context18.next){case 0:if(!this.disabled){_context18.next=3;break;}this.logMsgIfDebug(function(){return console.warn('[PostHog] The client is disabled');});return _context18.abrupt("return");case 3:if(this._isInitialized){_context18.next=6;break;}_context18.next=6;return this._initPromise;case 6:if(!this.optedOut){_context18.next=9;break;}this._events.emit(type,"Library is disabled. Not sending event. To re-enable, call posthog.optIn()");return _context18.abrupt("return");case 9:data={api_key:this.apiKey,batch:[this.prepareMessage(type,_message,options)],sent_at:(0,_utils2.currentISOTime)()};if(this.historicalMigration){data.historical_migration=true;}payload=JSON.stringify(data);url=this.captureMode==='form'?"".concat(this.host,"/e/?ip=1&_=").concat((0,_utils2.currentTimestamp)(),"&v=").concat(this.getLibraryVersion()):"".concat(this.host,"/batch/");fetchOptions=this.captureMode==='form'?{method:'POST',mode:'no-cors',credentials:'omit',headers:_objectSpread(_objectSpread({},this.getCustomHeaders()),{},{'Content-Type':'application/x-www-form-urlencoded'}),body:"data=".concat(encodeURIComponent(_lzString.LZString.compressToBase64(payload)),"&compression=lz64")}:{method:'POST',headers:_objectSpread(_objectSpread({},this.getCustomHeaders()),{},{'Content-Type':'application/json'}),body:payload};_context18.prev=14;_context18.next=17;return this.fetchWithRetry(url,fetchOptions);case 17:_context18.next=22;break;case 19:_context18.prev=19;_context18.t0=_context18["catch"](14);this._events.emit('error',_context18.t0);case 22:case"end":return _context18.stop();}},_callee18,this,[[14,19]]);}));function sendImmediate(_x26,_x27,_x28){return _sendImmediate.apply(this,arguments);}return sendImmediate;}()},{key:"prepareMessage",value:function prepareMessage(type,_message,options){var _a;var message=_objectSpread(_objectSpread({},_message),{},{type:type,library:this.getLibraryId(),library_version:this.getLibraryVersion(),timestamp:(options===null||options===void 0?void 0:options.timestamp)?options===null||options===void 0?void 0:options.timestamp:(0,_utils2.currentISOTime)(),uuid:(options===null||options===void 0?void 0:options.uuid)?options.uuid:(0,_uuidv.uuidv7)()});var addGeoipDisableProperty=(_a=options===null||options===void 0?void 0:options.disableGeoip)!==null&&_a!==void 0?_a:this.disableGeoip;if(addGeoipDisableProperty){if(!message.properties){message.properties={};}message['properties']['$geoip_disable']=true;}if(message.distinctId){message.distinct_id=message.distinctId;delete message.distinctId;}return message;}},{key:"clearFlushTimer",value:function clearFlushTimer(){if(this._flushTimer){clearTimeout(this._flushTimer);this._flushTimer=undefined;}}},{key:"flushBackground",value:function flushBackground(){void this.flush()["catch"](function(){var _ref2=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee19(err){return _regenerator["default"].wrap(function _callee19$(_context19){while(1)switch(_context19.prev=_context19.next){case 0:_context19.next=2;return logFlushError(err);case 2:case"end":return _context19.stop();}},_callee19);}));return function(_x29){return _ref2.apply(this,arguments);};}());}},{key:"flush",value:(function(){var _flush2=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee20(){var _this17=this;var nextFlushPromise;return _regenerator["default"].wrap(function _callee20$(_context20){while(1)switch(_context20.prev=_context20.next){case 0:nextFlushPromise=(0,_utils2.allSettled)([this.flushPromise]).then(function(){return _this17._flush();});this.flushPromise=nextFlushPromise;void this.addPendingPromise(nextFlushPromise);(0,_utils2.allSettled)([nextFlushPromise]).then(function(){if(_this17.flushPromise===nextFlushPromise){_this17.flushPromise=null;}});return _context20.abrupt("return",nextFlushPromise);case 5:case"end":return _context20.stop();}},_callee20,this);}));function flush(){return _flush2.apply(this,arguments);}return flush;}())},{key:"getCustomHeaders",value:function getCustomHeaders(){var customUserAgent=this.getCustomUserAgent();var headers={};if(customUserAgent&&customUserAgent!==''){headers['User-Agent']=customUserAgent;}return headers;}},{key:"_flush",value:function(){var _flush3=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee21(){var _this18=this;var queue,sentMessages,originalQueueLength,_loop;return _regenerator["default"].wrap(function _callee21$(_context22){while(1)switch(_context22.prev=_context22.next){case 0:this.clearFlushTimer();_context22.next=3;return this._initPromise;case 3:queue=this.getPersistedProperty(_types.PostHogPersistedProperty.Queue)||[];if(queue.length){_context22.next=6;break;}return _context22.abrupt("return");case 6:sentMessages=[];originalQueueLength=queue.length;_loop=_regenerator["default"].mark(function _loop(){var batchItems,batchMessages,persistQueueChange,data,payload,url,fetchOptions,retryOptions;return _regenerator["default"].wrap(function _loop$(_context21){while(1)switch(_context21.prev=_context21.next){case 0:batchItems=queue.slice(0,_this18.maxBatchSize);batchMessages=batchItems.map(function(item){return item.message;});persistQueueChange=function persistQueueChange(){var refreshedQueue=_this18.getPersistedProperty(_types.PostHogPersistedProperty.Queue)||[];var newQueue=refreshedQueue.slice(batchItems.length);_this18.setPersistedProperty(_types.PostHogPersistedProperty.Queue,newQueue);queue=newQueue;};data={api_key:_this18.apiKey,batch:batchMessages,sent_at:(0,_utils2.currentISOTime)()};if(_this18.historicalMigration){data.historical_migration=true;}payload=JSON.stringify(data);url=_this18.captureMode==='form'?"".concat(_this18.host,"/e/?ip=1&_=").concat((0,_utils2.currentTimestamp)(),"&v=").concat(_this18.getLibraryVersion()):"".concat(_this18.host,"/batch/");fetchOptions=_this18.captureMode==='form'?{method:'POST',mode:'no-cors',credentials:'omit',headers:_objectSpread(_objectSpread({},_this18.getCustomHeaders()),{},{'Content-Type':'application/x-www-form-urlencoded'}),body:"data=".concat(encodeURIComponent(_lzString.LZString.compressToBase64(payload)),"&compression=lz64")}:{method:'POST',headers:_objectSpread(_objectSpread({},_this18.getCustomHeaders()),{},{'Content-Type':'application/json'}),body:payload};retryOptions={retryCheck:function retryCheck(err){if(isPostHogFetchContentTooLargeError(err)){return false;}return isPostHogFetchError(err);}};_context21.prev=9;_context21.next=12;return _this18.fetchWithRetry(url,fetchOptions,retryOptions);case 12:_context21.next=23;break;case 14:_context21.prev=14;_context21.t0=_context21["catch"](9);if(!(isPostHogFetchContentTooLargeError(_context21.t0)&&batchMessages.length>1)){_context21.next=20;break;}_this18.maxBatchSize=Math.max(1,Math.floor(batchMessages.length/2));_this18.logMsgIfDebug(function(){return console.warn("Received 413 when sending batch of size ".concat(batchMessages.length,", reducing batch size to ").concat(_this18.maxBatchSize));});return _context21.abrupt("return",1);case 20:if(!(_context21.t0 instanceof PostHogFetchNetworkError)){persistQueueChange();}_this18._events.emit('error',_context21.t0);throw _context21.t0;case 23:persistQueueChange();sentMessages.push.apply(sentMessages,(0,_toConsumableArray2["default"])(batchMessages));case 25:case"end":return _context21.stop();}},_loop,null,[[9,14]]);});case 9:if(!(queue.length>0&&sentMessages.length<originalQueueLength)){_context22.next=15;break;}return _context22.delegateYield(_loop(),"t0",11);case 11:if(!_context22.t0){_context22.next=13;break;}return _context22.abrupt("continue",9);case 13:_context22.next=9;break;case 15:this._events.emit('flush',sentMessages);case 16:case"end":return _context22.stop();}},_callee21,this);}));function _flush(){return _flush3.apply(this,arguments);}return _flush;}()},{key:"fetchWithRetry",value:function(){var _fetchWithRetry=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee23(url,options,retryOptions,requestTimeout){var _this19=this;var _a,_b,body,reqByteLength,encoded;return _regenerator["default"].wrap(function _callee23$(_context24){while(1)switch(_context24.prev=_context24.next){case 0:;(_a=(_b=AbortSignal).timeout)!==null&&_a!==void 0?_a:_b.timeout=function timeout(ms){var ctrl=new AbortController();setTimeout(function(){return ctrl.abort();},ms);return ctrl.signal;};body=options.body?options.body:'';reqByteLength=-1;try{reqByteLength=Buffer.byteLength(body,_utils2.STRING_FORMAT);}catch(_c){encoded=new TextEncoder().encode(body);reqByteLength=encoded.length;}_context24.next=7;return(0,_utils2.retriable)((0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee22(){var res,isNoCors;return _regenerator["default"].wrap(function _callee22$(_context23){while(1)switch(_context23.prev=_context23.next){case 0:res=null;_context23.prev=1;_context23.next=4;return _this19.fetch(url,_objectSpread({signal:AbortSignal.timeout(requestTimeout!==null&&requestTimeout!==void 0?requestTimeout:_this19.requestTimeout)},options));case 4:res=_context23.sent;_context23.next=10;break;case 7:_context23.prev=7;_context23.t0=_context23["catch"](1);throw new PostHogFetchNetworkError(_context23.t0);case 10:isNoCors=options.mode==='no-cors';if(!(!isNoCors&&(res.status<200||res.status>=400))){_context23.next=13;break;}throw new PostHogFetchHttpError(res,reqByteLength);case 13:return _context23.abrupt("return",res);case 14:case"end":return _context23.stop();}},_callee22,null,[[1,7]]);})),_objectSpread(_objectSpread({},this._retryOptions),retryOptions));case 7:return _context24.abrupt("return",_context24.sent);case 8:case"end":return _context24.stop();}},_callee23,this);}));function fetchWithRetry(_x30,_x31,_x32,_x33){return _fetchWithRetry.apply(this,arguments);}return fetchWithRetry;}()},{key:"_shutdown",value:function(){var _shutdown2=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee25(){var _this20=this;var shutdownTimeoutMs,hasTimedOut,doShutdown,_args26=arguments;return _regenerator["default"].wrap(function _callee25$(_context26){while(1)switch(_context26.prev=_context26.next){case 0:shutdownTimeoutMs=_args26.length>0&&_args26[0]!==undefined?_args26[0]:30000;_context26.next=3;return this._initPromise;case 3:hasTimedOut=false;this.clearFlushTimer();doShutdown=function(){var _ref4=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee24(){var queue;return _regenerator["default"].wrap(function _callee24$(_context25){while(1)switch(_context25.prev=_context25.next){case 0:_context25.prev=0;_context25.next=3;return Promise.all(Object.values(_this20.pendingPromises));case 3:if(!true){_context25.next=13;break;}queue=_this20.getPersistedProperty(_types.PostHogPersistedProperty.Queue)||[];if(!(queue.length===0)){_context25.next=7;break;}return _context25.abrupt("break",13);case 7:_context25.next=9;return _this20.flush();case 9:if(!hasTimedOut){_context25.next=11;break;}return _context25.abrupt("break",13);case 11:_context25.next=3;break;case 13:_context25.next=21;break;case 15:_context25.prev=15;_context25.t0=_context25["catch"](0);if(isPostHogFetchError(_context25.t0)){_context25.next=19;break;}throw _context25.t0;case 19:_context25.next=21;return logFlushError(_context25.t0);case 21:case"end":return _context25.stop();}},_callee24,null,[[0,15]]);}));return function doShutdown(){return _ref4.apply(this,arguments);};}();return _context26.abrupt("return",Promise.race([new Promise(function(_,reject){(0,_utils2.safeSetTimeout)(function(){_this20.logMsgIfDebug(function(){return console.error('Timed out while shutting down PostHog');});hasTimedOut=true;reject('Timeout while shutting down PostHog. Some events may not have been sent.');},shutdownTimeoutMs);}),doShutdown()]));case 7:case"end":return _context26.stop();}},_callee25,this);}));function _shutdown(){return _shutdown2.apply(this,arguments);}return _shutdown;}()},{key:"shutdown",value:(function(){var _shutdown3=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee26(){var _this21=this;var shutdownTimeoutMs,_args27=arguments;return _regenerator["default"].wrap(function _callee26$(_context27){while(1)switch(_context27.prev=_context27.next){case 0:shutdownTimeoutMs=_args27.length>0&&_args27[0]!==undefined?_args27[0]:30000;if(this.shutdownPromise){this.logMsgIfDebug(function(){return console.warn('shutdown() called while already shutting down. shutdown() is meant to be called once before process exit - use flush() for per-request cleanup');});}else{this.shutdownPromise=this._shutdown(shutdownTimeoutMs)["finally"](function(){_this21.shutdownPromise=null;});}return _context27.abrupt("return",this.shutdownPromise);case 3:case"end":return _context27.stop();}},_callee26,this);}));function shutdown(){return _shutdown3.apply(this,arguments);}return shutdown;}())}]);}();var PostHogCore=exports.PostHogCore=function(_PostHogCoreStateless){function PostHogCore(apiKey,options){var _this22;(0,_classCallCheck2["default"])(this,PostHogCore);var _a,_b,_c,_d;var disableGeoipOption=(_a=options===null||options===void 0?void 0:options.disableGeoip)!==null&&_a!==void 0?_a:false;var featureFlagsRequestTimeoutMs=(_b=options===null||options===void 0?void 0:options.featureFlagsRequestTimeoutMs)!==null&&_b!==void 0?_b:10000;_this22=_callSuper(this,PostHogCore,[apiKey,_objectSpread(_objectSpread({},options),{},{disableGeoip:disableGeoipOption,featureFlagsRequestTimeoutMs:featureFlagsRequestTimeoutMs})]);_this22.flagCallReported={};_this22._sessionMaxLengthSeconds=24*60*60;_this22.sessionProps={};_this22.sendFeatureFlagEvent=(_c=options===null||options===void 0?void 0:options.sendFeatureFlagEvent)!==null&&_c!==void 0?_c:true;_this22._sessionExpirationTimeSeconds=(_d=options===null||options===void 0?void 0:options.sessionExpirationTimeSeconds)!==null&&_d!==void 0?_d:1800;return _this22;}(0,_inherits2["default"])(PostHogCore,_PostHogCoreStateless);return(0,_createClass2["default"])(PostHogCore,[{key:"setupBootstrap",value:function setupBootstrap(options){var _a;var bootstrap=options===null||options===void 0?void 0:options.bootstrap;if(!bootstrap){return;}if(bootstrap.distinctId){if(bootstrap.isIdentifiedId){var distinctId=this.getPersistedProperty(_types.PostHogPersistedProperty.DistinctId);if(!distinctId){this.setPersistedProperty(_types.PostHogPersistedProperty.DistinctId,bootstrap.distinctId);}}else{var anonymousId=this.getPersistedProperty(_types.PostHogPersistedProperty.AnonymousId);if(!anonymousId){this.setPersistedProperty(_types.PostHogPersistedProperty.AnonymousId,bootstrap.distinctId);}}}var bootstrapFeatureFlags=bootstrap.featureFlags;var bootstrapFeatureFlagPayloads=(_a=bootstrap.featureFlagPayloads)!==null&&_a!==void 0?_a:{};if(bootstrapFeatureFlags&&Object.keys(bootstrapFeatureFlags).length){var normalizedBootstrapFeatureFlagDetails=(0,_featureFlagUtils.createDecideResponseFromFlagsAndPayloads)(bootstrapFeatureFlags,bootstrapFeatureFlagPayloads);if(Object.keys(normalizedBootstrapFeatureFlagDetails.flags).length>0){this.setBootstrappedFeatureFlagDetails(normalizedBootstrapFeatureFlagDetails);var currentFeatureFlagDetails=this.getKnownFeatureFlagDetails()||{flags:{},requestId:undefined};var newFeatureFlagDetails={flags:_objectSpread(_objectSpread({},normalizedBootstrapFeatureFlagDetails.flags),currentFeatureFlagDetails.flags),requestId:normalizedBootstrapFeatureFlagDetails.requestId};this.setKnownFeatureFlagDetails(newFeatureFlagDetails);}}}},{key:"clearProps",value:function clearProps(){this.props=undefined;this.sessionProps={};this.flagCallReported={};}},{key:"on",value:function on(event,cb){return this._events.on(event,cb);}},{key:"reset",value:function reset(propertiesToKeep){var _this23=this;this.wrap(function(){var allPropertiesToKeep=[_types.PostHogPersistedProperty.Queue].concat((0,_toConsumableArray2["default"])(propertiesToKeep||[]));_this23.clearProps();for(var _i=0,_Object$keys=Object.keys(_types.PostHogPersistedProperty);_i<_Object$keys.length;_i++){var key=_Object$keys[_i];if(!allPropertiesToKeep.includes(_types.PostHogPersistedProperty[key])){_this23.setPersistedProperty(_types.PostHogPersistedProperty[key],null);}}_this23.reloadFeatureFlags();});}},{key:"getCommonEventProperties",value:function getCommonEventProperties(){var featureFlags=this.getFeatureFlags();var featureVariantProperties={};if(featureFlags){for(var _i2=0,_Object$entries=Object.entries(featureFlags);_i2<_Object$entries.length;_i2++){var _Object$entries$_i=(0,_slicedToArray2["default"])(_Object$entries[_i2],2),feature=_Object$entries$_i[0],variant=_Object$entries$_i[1];featureVariantProperties["$feature/".concat(feature)]=variant;}}return _objectSpread(_objectSpread(_objectSpread({},maybeAdd('$active_feature_flags',featureFlags?Object.keys(featureFlags):undefined)),featureVariantProperties),_superPropGet(PostHogCore,"getCommonEventProperties",this,3)([]));}},{key:"enrichProperties",value:function enrichProperties(properties){return _objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread({},this.props),this.sessionProps),properties||{}),this.getCommonEventProperties()),{},{$session_id:this.getSessionId()});}},{key:"getSessionId",value:function getSessionId(){if(!this._isInitialized){return'';}var sessionId=this.getPersistedProperty(_types.PostHogPersistedProperty.SessionId);var sessionLastTimestamp=this.getPersistedProperty(_types.PostHogPersistedProperty.SessionLastTimestamp)||0;var sessionStartTimestamp=this.getPersistedProperty(_types.PostHogPersistedProperty.SessionStartTimestamp)||0;var now=Date.now();var sessionLastDif=now-sessionLastTimestamp;var sessionStartDif=now-sessionStartTimestamp;if(!sessionId||sessionLastDif>this._sessionExpirationTimeSeconds*1000||sessionStartDif>this._sessionMaxLengthSeconds*1000){sessionId=(0,_uuidv.uuidv7)();this.setPersistedProperty(_types.PostHogPersistedProperty.SessionId,sessionId);this.setPersistedProperty(_types.PostHogPersistedProperty.SessionStartTimestamp,now);}this.setPersistedProperty(_types.PostHogPersistedProperty.SessionLastTimestamp,now);return sessionId;}},{key:"resetSessionId",value:function resetSessionId(){var _this24=this;this.wrap(function(){_this24.setPersistedProperty(_types.PostHogPersistedProperty.SessionId,null);_this24.setPersistedProperty(_types.PostHogPersistedProperty.SessionLastTimestamp,null);_this24.setPersistedProperty(_types.PostHogPersistedProperty.SessionStartTimestamp,null);});}},{key:"getAnonymousId",value:function getAnonymousId(){if(!this._isInitialized){return'';}var anonId=this.getPersistedProperty(_types.PostHogPersistedProperty.AnonymousId);if(!anonId){anonId=(0,_uuidv.uuidv7)();this.setPersistedProperty(_types.PostHogPersistedProperty.AnonymousId,anonId);}return anonId;}},{key:"getDistinctId",value:function getDistinctId(){if(!this._isInitialized){return'';}return this.getPersistedProperty(_types.PostHogPersistedProperty.DistinctId)||this.getAnonymousId();}},{key:"registerForSession",value:function registerForSession(properties){this.sessionProps=_objectSpread(_objectSpread({},this.sessionProps),properties);}},{key:"unregisterForSession",value:function unregisterForSession(property){delete this.sessionProps[property];}},{key:"identify",value:function identify(distinctId,properties,options){var _this25=this;this.wrap(function(){var previousDistinctId=_this25.getDistinctId();distinctId=distinctId||previousDistinctId;if(properties===null||properties===void 0?void 0:properties.$groups){_this25.groups(properties.$groups);}var userPropsOnce=properties===null||properties===void 0?void 0:properties.$set_once;properties===null||properties===void 0?true:delete properties.$set_once;var userProps=(properties===null||properties===void 0?void 0:properties.$set)||properties;var allProperties=_this25.enrichProperties(_objectSpread(_objectSpread({$anon_distinct_id:_this25.getAnonymousId()},maybeAdd('$set',userProps)),maybeAdd('$set_once',userPropsOnce)));if(distinctId!==previousDistinctId){_this25.setPersistedProperty(_types.PostHogPersistedProperty.AnonymousId,previousDistinctId);_this25.setPersistedProperty(_types.PostHogPersistedProperty.DistinctId,distinctId);_this25.reloadFeatureFlags();}_superPropGet(PostHogCore,"identifyStateless",_this25,3)([distinctId,allProperties,options]);});}},{key:"capture",value:function capture(event,properties,options){var _this26=this;this.wrap(function(){var distinctId=_this26.getDistinctId();if(properties===null||properties===void 0?void 0:properties.$groups){_this26.groups(properties.$groups);}var allProperties=_this26.enrichProperties(properties);_superPropGet(PostHogCore,"captureStateless",_this26,3)([distinctId,event,allProperties,options]);});}},{key:"alias",value:function alias(_alias){var _this27=this;this.wrap(function(){var distinctId=_this27.getDistinctId();var allProperties=_this27.enrichProperties({});_superPropGet(PostHogCore,"aliasStateless",_this27,3)([_alias,distinctId,allProperties]);});}},{key:"autocapture",value:function autocapture(eventType,elements){var _this28=this;var properties=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var options=arguments.length>3?arguments[3]:undefined;this.wrap(function(){var distinctId=_this28.getDistinctId();var payload={distinct_id:distinctId,event:'$autocapture',properties:_objectSpread(_objectSpread({},_this28.enrichProperties(properties)),{},{$event_type:eventType,$elements:elements})};_this28.enqueue('autocapture',payload,options);});}},{key:"groups",value:function groups(_groups){var _this29=this;this.wrap(function(){var existingGroups=_this29.props.$groups||{};_this29.register({$groups:_objectSpread(_objectSpread({},existingGroups),_groups)});if(Object.keys(_groups).find(function(type){return existingGroups[type]!==_groups[type];})){_this29.reloadFeatureFlags();}});}},{key:"group",value:function group(groupType,groupKey,groupProperties,options){var _this30=this;this.wrap(function(){_this30.groups((0,_defineProperty2["default"])({},groupType,groupKey));if(groupProperties){_this30.groupIdentify(groupType,groupKey,groupProperties,options);}});}},{key:"groupIdentify",value:function groupIdentify(groupType,groupKey,groupProperties,options){var _this31=this;this.wrap(function(){var distinctId=_this31.getDistinctId();var eventProperties=_this31.enrichProperties({});_superPropGet(PostHogCore,"groupIdentifyStateless",_this31,3)([groupType,groupKey,groupProperties,options,distinctId,eventProperties]);});}},{key:"setPersonPropertiesForFlags",value:function setPersonPropertiesForFlags(properties){var _this32=this;this.wrap(function(){var existingProperties=_this32.getPersistedProperty(_types.PostHogPersistedProperty.PersonProperties)||{};_this32.setPersistedProperty(_types.PostHogPersistedProperty.PersonProperties,_objectSpread(_objectSpread({},existingProperties),properties));});}},{key:"resetPersonPropertiesForFlags",value:function resetPersonPropertiesForFlags(){var _this33=this;this.wrap(function(){_this33.setPersistedProperty(_types.PostHogPersistedProperty.PersonProperties,null);});}},{key:"personProperties",value:function personProperties(properties){return this.setPersonPropertiesForFlags(properties);}},{key:"setGroupPropertiesForFlags",value:function setGroupPropertiesForFlags(properties){var _this34=this;this.wrap(function(){var existingProperties=_this34.getPersistedProperty(_types.PostHogPersistedProperty.GroupProperties)||{};if(Object.keys(existingProperties).length!==0){Object.keys(existingProperties).forEach(function(groupType){existingProperties[groupType]=_objectSpread(_objectSpread({},existingProperties[groupType]),properties[groupType]);delete properties[groupType];});}_this34.setPersistedProperty(_types.PostHogPersistedProperty.GroupProperties,_objectSpread(_objectSpread({},existingProperties),properties));});}},{key:"resetGroupPropertiesForFlags",value:function resetGroupPropertiesForFlags(){var _this35=this;this.wrap(function(){_this35.setPersistedProperty(_types.PostHogPersistedProperty.GroupProperties,null);});}},{key:"groupProperties",value:function groupProperties(properties){var _this36=this;this.wrap(function(){_this36.setGroupPropertiesForFlags(properties);});}},{key:"remoteConfigAsync",value:function(){var _remoteConfigAsync2=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee27(){return _regenerator["default"].wrap(function _callee27$(_context28){while(1)switch(_context28.prev=_context28.next){case 0:_context28.next=2;return this._initPromise;case 2:if(!this._remoteConfigResponsePromise){_context28.next=4;break;}return _context28.abrupt("return",this._remoteConfigResponsePromise);case 4:return _context28.abrupt("return",this._remoteConfigAsync());case 5:case"end":return _context28.stop();}},_callee27,this);}));function remoteConfigAsync(){return _remoteConfigAsync2.apply(this,arguments);}return remoteConfigAsync;}()},{key:"decideAsync",value:(function(){var _decideAsync2=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee28(){var sendAnonDistinctId,_args29=arguments;return _regenerator["default"].wrap(function _callee28$(_context29){while(1)switch(_context29.prev=_context29.next){case 0:sendAnonDistinctId=_args29.length>0&&_args29[0]!==undefined?_args29[0]:true;_context29.next=3;return this._initPromise;case 3:if(!this._decideResponsePromise){_context29.next=5;break;}return _context29.abrupt("return",this._decideResponsePromise);case 5:return _context29.abrupt("return",this._decideAsync(sendAnonDistinctId));case 6:case"end":return _context29.stop();}},_callee28,this);}));function decideAsync(){return _decideAsync2.apply(this,arguments);}return decideAsync;}())},{key:"cacheSessionReplay",value:function cacheSessionReplay(source,response){var sessionReplay=response===null||response===void 0?void 0:response.sessionRecording;if(sessionReplay){this.setPersistedProperty(_types.PostHogPersistedProperty.SessionReplay,sessionReplay);this.logMsgIfDebug(function(){return console.log('PostHog Debug',"Session replay config from ".concat(source,": "),JSON.stringify(sessionReplay));});}else if(typeof sessionReplay==='boolean'&&sessionReplay===false){this.logMsgIfDebug(function(){return console.info('PostHog Debug',"Session replay config from ".concat(source," disabled."));});this.setPersistedProperty(_types.PostHogPersistedProperty.SessionReplay,null);}}},{key:"_remoteConfigAsync",value:function(){var _remoteConfigAsync3=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee29(){var _this37=this;return _regenerator["default"].wrap(function _callee29$(_context30){while(1)switch(_context30.prev=_context30.next){case 0:this._remoteConfigResponsePromise=this._initPromise.then(function(){var remoteConfig=_this37.getPersistedProperty(_types.PostHogPersistedProperty.RemoteConfig);_this37.logMsgIfDebug(function(){return console.log('PostHog Debug','Cached remote config: ',JSON.stringify(remoteConfig));});return _superPropGet(PostHogCore,"getRemoteConfig",_this37,3)([]).then(function(response){if(response){var remoteConfigWithoutSurveys=_objectSpread({},response);delete remoteConfigWithoutSurveys.surveys;_this37.logMsgIfDebug(function(){return console.log('PostHog Debug','Fetched remote config: ',JSON.stringify(remoteConfigWithoutSurveys));});if(_this37.disableSurveys===false){var surveys=response.surveys;var hasSurveys=true;if(!Array.isArray(surveys)){_this37.logMsgIfDebug(function(){return console.log('PostHog Debug','There are no surveys.');});hasSurveys=false;}else{_this37.logMsgIfDebug(function(){return console.log('PostHog Debug','Surveys fetched from remote config: ',JSON.stringify(surveys));});}if(hasSurveys){_this37.setPersistedProperty(_types.PostHogPersistedProperty.Surveys,surveys);}else{_this37.setPersistedProperty(_types.PostHogPersistedProperty.Surveys,null);}}else{_this37.setPersistedProperty(_types.PostHogPersistedProperty.Surveys,null);}_this37.setPersistedProperty(_types.PostHogPersistedProperty.RemoteConfig,remoteConfigWithoutSurveys);_this37.cacheSessionReplay('remote config',response);if(response.hasFeatureFlags===false){_this37.setKnownFeatureFlagDetails({flags:{}});_this37.logMsgIfDebug(function(){return console.warn('Remote config has no feature flags, will not load feature flags.');});}else if(_this37.preloadFeatureFlags!==false){_this37.reloadFeatureFlags();}remoteConfig=response;}return remoteConfig;});})["finally"](function(){_this37._remoteConfigResponsePromise=undefined;});return _context30.abrupt("return",this._remoteConfigResponsePromise);case 2:case"end":return _context30.stop();}},_callee29,this);}));function _remoteConfigAsync(){return _remoteConfigAsync3.apply(this,arguments);}return _remoteConfigAsync;}()},{key:"_decideAsync",value:function(){var _decideAsync3=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee31(){var _this38=this;var sendAnonDistinctId,_args32=arguments;return _regenerator["default"].wrap(function _callee31$(_context32){while(1)switch(_context32.prev=_context32.next){case 0:sendAnonDistinctId=_args32.length>0&&_args32[0]!==undefined?_args32[0]:true;this._decideResponsePromise=this._initPromise.then((0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee30(){var _a,distinctId,groups,personProperties,groupProperties,extraProperties,res,newFeatureFlagDetails,currentFlagDetails;return _regenerator["default"].wrap(function _callee30$(_context31){while(1)switch(_context31.prev=_context31.next){case 0:distinctId=_this38.getDistinctId();groups=_this38.props.$groups||{};personProperties=_this38.getPersistedProperty(_types.PostHogPersistedProperty.PersonProperties)||{};groupProperties=_this38.getPersistedProperty(_types.PostHogPersistedProperty.GroupProperties)||{};extraProperties={$anon_distinct_id:sendAnonDistinctId?_this38.getAnonymousId():undefined};_context31.next=7;return _superPropGet(PostHogCore,"getDecide",_this38,3)([distinctId,groups,personProperties,groupProperties,extraProperties]);case 7:res=_context31.sent;if(!((_a=res===null||res===void 0?void 0:res.quotaLimited)===null||_a===void 0?void 0:_a.includes(QuotaLimitedFeature.FeatureFlags))){_context31.next=12;break;}_this38.setKnownFeatureFlagDetails(null);console.warn('[FEATURE FLAGS] Feature flags quota limit exceeded - unsetting all flags. Learn more about billing limits at https://posthog.com/docs/billing/limits-alerts');return _context31.abrupt("return",res);case 12:if(res===null||res===void 0?void 0:res.featureFlags){if(_this38.sendFeatureFlagEvent){_this38.flagCallReported={};}newFeatureFlagDetails=res;if(res.errorsWhileComputingFlags){currentFlagDetails=_this38.getKnownFeatureFlagDetails();_this38.logMsgIfDebug(function(){return console.log('PostHog Debug','Cached feature flags: ',JSON.stringify(currentFlagDetails));});newFeatureFlagDetails=_objectSpread(_objectSpread({},res),{},{flags:_objectSpread(_objectSpread({},currentFlagDetails===null||currentFlagDetails===void 0?void 0:currentFlagDetails.flags),res.flags)});}_this38.setKnownFeatureFlagDetails(newFeatureFlagDetails);_this38.setPersistedProperty(_types.PostHogPersistedProperty.DecideEndpointWasHit,true);_this38.cacheSessionReplay('decide/flags',res);}return _context31.abrupt("return",res);case 14:case"end":return _context31.stop();}},_callee30);})))["finally"](function(){_this38._decideResponsePromise=undefined;});return _context32.abrupt("return",this._decideResponsePromise);case 3:case"end":return _context32.stop();}},_callee31,this);}));function _decideAsync(){return _decideAsync3.apply(this,arguments);}return _decideAsync;}()},{key:"setKnownFeatureFlagDetails",value:function setKnownFeatureFlagDetails(decideResponse){var _this39=this;this.wrap(function(){var _a;_this39.setPersistedProperty(_types.PostHogPersistedProperty.FeatureFlagDetails,decideResponse);_this39._events.emit('featureflags',(0,_featureFlagUtils.getFlagValuesFromFlags)((_a=decideResponse===null||decideResponse===void 0?void 0:decideResponse.flags)!==null&&_a!==void 0?_a:{}));});}},{key:"getKnownFeatureFlagDetails",value:function getKnownFeatureFlagDetails(){var storedDetails=this.getPersistedProperty(_types.PostHogPersistedProperty.FeatureFlagDetails);if(!storedDetails){var featureFlags=this.getPersistedProperty(_types.PostHogPersistedProperty.FeatureFlags);var featureFlagPayloads=this.getPersistedProperty(_types.PostHogPersistedProperty.FeatureFlagPayloads);if(featureFlags===undefined&&featureFlagPayloads===undefined){return undefined;}return(0,_featureFlagUtils.createDecideResponseFromFlagsAndPayloads)(featureFlags!==null&&featureFlags!==void 0?featureFlags:{},featureFlagPayloads!==null&&featureFlagPayloads!==void 0?featureFlagPayloads:{});}return(0,_featureFlagUtils.normalizeDecideResponse)(storedDetails);}},{key:"getKnownFeatureFlags",value:function getKnownFeatureFlags(){var featureFlagDetails=this.getKnownFeatureFlagDetails();if(!featureFlagDetails){return undefined;}return(0,_featureFlagUtils.getFlagValuesFromFlags)(featureFlagDetails.flags);}},{key:"getKnownFeatureFlagPayloads",value:function getKnownFeatureFlagPayloads(){var featureFlagDetails=this.getKnownFeatureFlagDetails();if(!featureFlagDetails){return undefined;}return(0,_featureFlagUtils.getPayloadsFromFlags)(featureFlagDetails.flags);}},{key:"getBootstrappedFeatureFlagDetails",value:function getBootstrappedFeatureFlagDetails(){var details=this.getPersistedProperty(_types.PostHogPersistedProperty.BootstrapFeatureFlagDetails);if(!details){return undefined;}return details;}},{key:"setBootstrappedFeatureFlagDetails",value:function setBootstrappedFeatureFlagDetails(details){this.setPersistedProperty(_types.PostHogPersistedProperty.BootstrapFeatureFlagDetails,details);}},{key:"getBootstrappedFeatureFlags",value:function getBootstrappedFeatureFlags(){var details=this.getBootstrappedFeatureFlagDetails();if(!details){return undefined;}return(0,_featureFlagUtils.getFlagValuesFromFlags)(details.flags);}},{key:"getBootstrappedFeatureFlagPayloads",value:function getBootstrappedFeatureFlagPayloads(){var details=this.getBootstrappedFeatureFlagDetails();if(!details){return undefined;}return(0,_featureFlagUtils.getPayloadsFromFlags)(details.flags);}},{key:"getFeatureFlag",value:function getFeatureFlag(key){var _a,_b,_c,_d,_e,_f,_g;var details=this.getFeatureFlagDetails();if(!details){return undefined;}var featureFlag=details.flags[key];var response=(0,_featureFlagUtils.getFeatureFlagValue)(featureFlag);if(response===undefined){response=false;}if(this.sendFeatureFlagEvent&&!this.flagCallReported[key]){var bootstrappedResponse=(_a=this.getBootstrappedFeatureFlags())===null||_a===void 0?void 0:_a[key];var bootstrappedPayload=(_b=this.getBootstrappedFeatureFlagPayloads())===null||_b===void 0?void 0:_b[key];this.flagCallReported[key]=true;this.capture('$feature_flag_called',_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread(_objectSpread({$feature_flag:key,$feature_flag_response:response},maybeAdd('$feature_flag_id',(_c=featureFlag===null||featureFlag===void 0?void 0:featureFlag.metadata)===null||_c===void 0?void 0:_c.id)),maybeAdd('$feature_flag_version',(_d=featureFlag===null||featureFlag===void 0?void 0:featureFlag.metadata)===null||_d===void 0?void 0:_d.version)),maybeAdd('$feature_flag_reason',(_f=(_e=featureFlag===null||featureFlag===void 0?void 0:featureFlag.reason)===null||_e===void 0?void 0:_e.description)!==null&&_f!==void 0?_f:(_g=featureFlag===null||featureFlag===void 0?void 0:featureFlag.reason)===null||_g===void 0?void 0:_g.code)),maybeAdd('$feature_flag_bootstrapped_response',bootstrappedResponse)),maybeAdd('$feature_flag_bootstrapped_payload',bootstrappedPayload)),{},{$used_bootstrap_value:!this.getPersistedProperty(_types.PostHogPersistedProperty.DecideEndpointWasHit)},maybeAdd('$feature_flag_request_id',details.requestId)));}return response;}},{key:"getFeatureFlagPayload",value:function getFeatureFlagPayload(key){var payloads=this.getFeatureFlagPayloads();if(!payloads){return undefined;}var response=payloads[key];if(response===undefined){return null;}return response;}},{key:"getFeatureFlagPayloads",value:function getFeatureFlagPayloads(){var _a;return(_a=this.getFeatureFlagDetails())===null||_a===void 0?void 0:_a.featureFlagPayloads;}},{key:"getFeatureFlags",value:function getFeatureFlags(){var _a;return(_a=this.getFeatureFlagDetails())===null||_a===void 0?void 0:_a.featureFlags;}},{key:"getFeatureFlagDetails",value:function getFeatureFlagDetails(){var _a;var details=this.getKnownFeatureFlagDetails();var overriddenFlags=this.getPersistedProperty(_types.PostHogPersistedProperty.OverrideFeatureFlags);if(!overriddenFlags){return details;}details=details!==null&&details!==void 0?details:{featureFlags:{},featureFlagPayloads:{},flags:{}};var flags=(_a=details.flags)!==null&&_a!==void 0?_a:{};for(var key in overriddenFlags){if(!overriddenFlags[key]){delete flags[key];}else{flags[key]=(0,_featureFlagUtils.updateFlagValue)(flags[key],overriddenFlags[key]);}}var result=_objectSpread(_objectSpread({},details),{},{flags:flags});return(0,_featureFlagUtils.normalizeDecideResponse)(result);}},{key:"getFeatureFlagsAndPayloads",value:function getFeatureFlagsAndPayloads(){var flags=this.getFeatureFlags();var payloads=this.getFeatureFlagPayloads();return{flags:flags,payloads:payloads};}},{key:"isFeatureEnabled",value:function isFeatureEnabled(key){var response=this.getFeatureFlag(key);if(response===undefined){return undefined;}return!!response;}},{key:"reloadFeatureFlags",value:function reloadFeatureFlags(cb){var _this40=this;this.decideAsync().then(function(res){cb===null||cb===void 0?void 0:cb(undefined,res===null||res===void 0?void 0:res.featureFlags);})["catch"](function(e){cb===null||cb===void 0?void 0:cb(e,undefined);if(!cb){_this40.logMsgIfDebug(function(){return console.log('PostHog Debug','Error reloading feature flags',e);});}});}},{key:"reloadRemoteConfigAsync",value:function(){var _reloadRemoteConfigAsync=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee32(){return _regenerator["default"].wrap(function _callee32$(_context33){while(1)switch(_context33.prev=_context33.next){case 0:_context33.next=2;return this.remoteConfigAsync();case 2:return _context33.abrupt("return",_context33.sent);case 3:case"end":return _context33.stop();}},_callee32,this);}));function reloadRemoteConfigAsync(){return _reloadRemoteConfigAsync.apply(this,arguments);}return reloadRemoteConfigAsync;}()},{key:"reloadFeatureFlagsAsync",value:function(){var _reloadFeatureFlagsAsync=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee33(){var sendAnonDistinctId,_a,_args34=arguments;return _regenerator["default"].wrap(function _callee33$(_context34){while(1)switch(_context34.prev=_context34.next){case 0:sendAnonDistinctId=_args34.length>0&&_args34[0]!==undefined?_args34[0]:true;_context34.next=3;return this.decideAsync(sendAnonDistinctId);case 3:_context34.t1=_a=_context34.sent;_context34.t0=_context34.t1===null;if(_context34.t0){_context34.next=7;break;}_context34.t0=_a===void 0;case 7:if(!_context34.t0){_context34.next=11;break;}_context34.t2=void 0;_context34.next=12;break;case 11:_context34.t2=_a.featureFlags;case 12:return _context34.abrupt("return",_context34.t2);case 13:case"end":return _context34.stop();}},_callee33,this);}));function reloadFeatureFlagsAsync(){return _reloadFeatureFlagsAsync.apply(this,arguments);}return reloadFeatureFlagsAsync;}()},{key:"onFeatureFlags",value:function onFeatureFlags(cb){var _this41=this;return this.on('featureflags',(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee34(){var flags;return _regenerator["default"].wrap(function _callee34$(_context35){while(1)switch(_context35.prev=_context35.next){case 0:flags=_this41.getFeatureFlags();if(flags){cb(flags);}case 2:case"end":return _context35.stop();}},_callee34);})));}},{key:"onFeatureFlag",value:function onFeatureFlag(key,cb){var _this42=this;return this.on('featureflags',(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee35(){var flagResponse;return _regenerator["default"].wrap(function _callee35$(_context36){while(1)switch(_context36.prev=_context36.next){case 0:flagResponse=_this42.getFeatureFlag(key);if(flagResponse!==undefined){cb(flagResponse);}case 2:case"end":return _context36.stop();}},_callee35);})));}},{key:"overrideFeatureFlag",value:function(){var _overrideFeatureFlag=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee36(flags){var _this43=this;return _regenerator["default"].wrap(function _callee36$(_context37){while(1)switch(_context37.prev=_context37.next){case 0:this.wrap(function(){if(flags===null){return _this43.setPersistedProperty(_types.PostHogPersistedProperty.OverrideFeatureFlags,null);}return _this43.setPersistedProperty(_types.PostHogPersistedProperty.OverrideFeatureFlags,flags);});case 1:case"end":return _context37.stop();}},_callee36,this);}));function overrideFeatureFlag(_x34){return _overrideFeatureFlag.apply(this,arguments);}return overrideFeatureFlag;}()},{key:"captureException",value:function captureException(error,additionalProperties){var properties=_objectSpread({$exception_level:'error',$exception_list:[{type:(0,_utils2.isError)(error)?error.name:'Error',value:(0,_utils2.isError)(error)?error.message:error,mechanism:{handled:true,synthetic:false}}]},additionalProperties);properties.$exception_personURL=new URL("/project/".concat(this.apiKey,"/person/").concat(this.getDistinctId()),this.host).toString();this.capture('$exception',properties);}},{key:"captureTraceFeedback",value:function captureTraceFeedback(traceId,userFeedback){this.capture('$ai_feedback',{$ai_feedback_text:userFeedback,$ai_trace_id:String(traceId)});}},{key:"captureTraceMetric",value:function captureTraceMetric(traceId,metricName,metricValue){this.capture('$ai_metric',{$ai_metric_name:metricName,$ai_metric_value:String(metricValue),$ai_trace_id:String(traceId)});}}]);}(PostHogCoreStateless);